const { SlashCommandBuilder, AttachmentBuilder } = require('discord.js');
const eventBracket = require('../../Scripts/EventBracket');
const bracketRenderer = require('../../Scripts/BracketRenderer');
const db = require('../../database/database');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('event-bracket')
        .setDescription('Cria ou exibe a chave do torneio')
        .addSubcommand(sub =>
            sub
                .setName('create')
                .setDescription('Cria o torneio')
                .addBooleanOption(o => o.setName('lower').setDescription('Ativar chave inferior?').setRequired(true))
                .addStringOption(o => o.setName('participants').setDescription('Lista de nomes separados por vÃ­rgula').setRequired(true)))
        .addSubcommand(sub =>
            sub
                .setName('show')
                .setDescription('Mostra a chave atual')),

    async execute(interaction) {
        const sub = interaction.options.getSubcommand();

        if (sub === 'create') {
            const hasLower = interaction.options.getBoolean('lower');
            const list = interaction.options.getString('participants').split(',').map(t => t.trim());
            const rounds = eventBracket.createBracket(list, hasLower);
            const bracket = db.read('bracket', 'current');
            const buffer = await bracketRenderer.render(bracket);
            await interaction.reply({ content: 'Chave criada!', files: [new AttachmentBuilder(buffer, { name: 'bracket.png' })] });
        }

        if (sub === 'show') {
            const bracket = db.read('bracket', 'current');
            if (!bracket) return interaction.reply('Nenhum torneio ativo.');
            const buffer = await bracketRenderer.render(bracket);
            await interaction.reply({ files: [new AttachmentBuilder(buffer, { name: 'bracket.png' })] });
        }
    }
};
